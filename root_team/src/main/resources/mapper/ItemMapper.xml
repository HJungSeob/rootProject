<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="root.team.com.ItemMapper">

	<insert id="insertItem" parameterType="itemVO">
		INSERT INTO tb_item (c_idx, s_idx, i_name, i_price, i_explain,
		i_count)
		VALUES (#{c_idx}, #{s_idx}, #{i_name}, #{i_price}, #{i_explain}, #{i_count})
		<selectKey keyProperty="i_idx" order="AFTER" resultType="int">
			SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>

	<insert id="insertItemOption" parameterType="itemVO">
		INSERT INTO tb_item_option (i_idx, i_option0, i_option1, i_option2,
		i_option3, i_option4)
		VALUES (#{i_idx}, #{i_option0}, #{i_option1}, #{i_option2}, #{i_option3},
		#{i_option4})
	</insert>

	<insert id="insertItemImage" parameterType="itemVO">
		INSERT INTO tb_item_img (i_idx, i_saveimg0, i_saveimg1, i_saveimg2,
		i_saveimg3, i_saveimg4)
		VALUES (#{i_idx}, #{i_saveimg0}, #{i_saveimg1}, #{i_saveimg2},
		#{i_saveimg3}, #{i_saveimg4})
	</insert>

	<insert id="insertItemThumbnail" parameterType="itemVO">
		INSERT INTO tb_item_thumbnail (i_idx, i_thumbnail)
		VALUES (#{i_idx}, #{i_thumbnail})
	</insert>

	<select id="getItem" parameterType="_int" resultType="itemVO">
		SELECT 
		    *		    
		FROM 
		   vw_item   
		WHERE
			i_idx = #{i_idx}
	</select>

	<select id="getItems" parameterType="searchVO" resultType="itemVO">
		SELECT 
		    *		    
		FROM 
		   vw_item   
		WHERE 
        	1 = 1	
		<if test='c_idx != 0'>
			AND c_idx = #{c_idx}
		</if>
		<if test='p_idx != 0'>
			<choose>
				<when test='p_idx == 1'>
					AND c_idx BETWEEN 1 AND 5
				</when>
				<when test='p_idx == 2'>
					AND c_idx BETWEEN 6 AND 10
				</when>
				<when test='p_idx == 3'>
					AND c_idx BETWEEN 11 AND 15
				</when>
				<when test='p_idx == 4'>
					AND c_idx BETWEEN 16 AND 20
				</when>
				<when test='p_idx == 5'>
					AND c_idx BETWEEN 21 AND 25
				</when>
				<otherwise>
					
				</otherwise>
			</choose>
		</if>
		<if test="searchWord != null">
			<choose>
				<when test='searchField == "i_name"'>
					AND i_name like CONCAT('%',#{searchWord},'%')
				</when>
				<when test='searchField == "s_storename"'>
					AND s_storename like CONCAT('%',#{searchWord},'%')
				</when>
			</choose>
		</if>
		<if test="orderByType != null">
			<choose>
				<when test='orderByType == "pop"'>
					ORDER BY comment_count desc, avg_star desc 
				</when>
				<when test='orderByType == "new"'>
					ORDER BY i_idx desc
				</when>
			</choose>
		</if>
		<choose>
			<when test="viewNum != 0">
				LIMIT #{startIdx}, #{viewNum}
			</when>
			<otherwise>
				LIMIT 8
			</otherwise>
		</choose>	
	</select>

	<select id="getTotalCount" parameterType="searchVO"	resultType="_int">
		select count(*) from tb_category c, tb_item i, tb_seller_info si
		where
		i.c_idx = c.c_idx
		AND i.s_idx = si.s_idx	
		<if test='c_idx != 0'>
			AND i.c_idx = #{c_idx}
		</if>
		<if test='p_idx != 0'>
			<choose>
				<when test='p_idx == 1'>
					AND i.c_idx BETWEEN 1 AND 5
				</when>
				<when test='p_idx == 2'>
					AND i.c_idx BETWEEN 6 AND 10
				</when>
				<when test='p_idx == 3'>
					AND i.c_idx BETWEEN 11 AND 15
				</when>
				<when test='p_idx == 4'>
					AND i.c_idx BETWEEN 16 AND 20
				</when>
				<when test='p_idx == 5'>
					AND i.c_idx BETWEEN 21 AND 25
				</when>
				<otherwise>
					
				</otherwise>
			</choose>
		</if>
		<if test="searchWord != null">
			<choose>
				<when test='searchField == "i_name"'>
					AND i_name like CONCAT('%',#{searchWord},'%')
				</when>
				<when test='searchField == "s_storename"'>
					AND s_storename like CONCAT('%',#{searchWord},'%')
				</when>
			</choose>
		</if>
	</select>
	
	<insert id="insertReview" parameterType="reviewVO">
		INSERT INTO tb_buyer_review (bos_idx, br_content, br_star)
		VALUES (#{bos_idx}, #{br_content}, #{br_star})
	</insert>
	
	<select id="getReviews" parameterType="searchVO" resultType="reviewVO">
		SELECT 
		    *		    
		FROM 
		tb_buyer_review br, tb_buyer_info bi, tb_buyer_order_state bos, tb_buyer_order bo
		WHERE br.bos_idx = bos.bos_idx
		AND bos.bo_idx = bo.bo_idx
		AND bi.b_idx = bo.b_idx
		<if test="searchWord != null">
			AND bos_option like CONCAT('%',#{searchWord},'%')
		</if>
		<if test="br_star != 0">
			AND br_star = #{br_star}
		</if>
		AND i_idx = #{i_idx}
	</select>
	
	<select id="getReviewTotalCount" parameterType="searchVO" resultType="reviewVO">
		SELECT 
		count(*)		    
		FROM 
		tb_buyer_review br, tb_buyer_info bi, tb_buyer_order_state bos, tb_buyer_order bo
		WHERE br.bos_idx = bos.bos_idx
		AND bos.bo_idx = bo.bo_idx
		AND bi.b_idx = bo.b_idx
		<if test="searchWord != null">
			AND bos_option like CONCAT('%',#{searchWord},'%')
		</if>
		<if test="br_star != 0">
			AND br_star = #{br_star}
		</if>
		AND i_idx = #{i_idx}
	</select>

</mapper>